<<<<<<< HEAD
<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="author" content="Ajiu9"><meta http-equiv="X-UA-Compatible" content="chrome=1"><meta name="revisit-after" content="7 days"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" href="/favicon.svg" type="image/svg+xml"><link rel="alternate" type="application/rss+xml" title="Ajiu9's Blog" href="/feed.xml"><meta name="msapplication-TileColor" content="#ffffff"><title>在一个项目中同时使用ESM和CJS</title><script>!function(){var e=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,t=localStorage.getItem("vueuse-color-scheme")||"auto";("dark"===t||e&&"light"!==t)&&document.documentElement.classList.toggle("dark",!0)}()</script><script type="module" crossorigin="" src="/assets/app-Bh2XIWKG.js"></script><link rel="stylesheet" crossorigin="" href="/assets/app-DRnZP3lX.css"><link rel="modulepreload" crossorigin="" href="/assets/publish-esm-and-cjs-BMwfT8q4.js"><meta property="og:title" content="在一个项目中同时使用ESM和CJS"><meta name="twitter:title" content="在一个项目中同时使用ESM和CJS"><meta name="description" content="在单项目中运行ESM和CJS的简单介绍"><meta property="og:description" content="在单项目中运行ESM和CJS的简单介绍"><meta name="twitter:description" content="在单项目中运行ESM和CJS的简单介绍"><meta property="og:image" content="https://ajiu9.cn/og/publish-esm-and-cjs.png"><meta name="twitter:image" content="https://ajiu9.cn/og/publish-esm-and-cjs.png"><meta name="twitter:card" content="summary_large_image"></head><body class="font-sans text-gray-700 dark:text-gray-200 relative"><div id="app" data-server-rendered="true"><!--[--><header class="header z-40" data-v-89b7cfe3=""><a href="/" class="w-12 h-12 absolute xl:fixed m-5 select-none outline-none" focusable="false" data-v-89b7cfe3=""><svg class="svg" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-89b7cfe3="" data-v-6edbdcb7=""><title data-v-6edbdcb7="">Ajiu9</title><mask id="mask0_634_3" style="mask-type:alpha" width="47" height="80" data-v-6edbdcb7=""><path d="M23.5125 22.9252C33.7594 11.9188 21.3168 -4.95774 7.41017 3.11364C-6.49649 11.185 3.75055 40.5355 23.5125 22.9252ZM23.5125 22.9252C79.8707 -24.0356 12.5336 46.4057 12.5336 69.1523C12.5336 91.8989 36.8153 72.5834 16.9251 38.3343" fill="white" data-v-6edbdcb7=""></path></mask><g mask="url(#mask0_634_3)" data-v-6edbdcb7=""><path class="path1" d="M23.5125 22.9252C33.7594 11.9188 21.3168 -4.95774 7.41017 3.11364C-6.49649 11.185 3.75055 40.5355 23.5125 22.9252ZM23.5125 22.9252C79.8707 -24.0356 12.5336 46.4057 12.5336 69.1523C12.5336 91.8989 36.8153 72.5834 16.9251 38.3343" stroke="black" stroke-width="3.5" stroke-linecap="round" data-v-6edbdcb7=""></path></g></svg></a><button title="Scroll to top" fixed="" right-3="" bottom-3="" w-10="" h-10="" hover:op100="" rounded-full="" hover-bg-hex-8883="" transition="" duration-300="" z-100="" print:hidden="" class="op0! pointer-events-none" data-v-89b7cfe3=""><div i-ri-arrow-up-line="" data-v-89b7cfe3=""></div></button><nav class="nav" data-v-89b7cfe3=""><div class="spacer" data-v-89b7cfe3=""></div><div class="right" print:op0="" data-v-89b7cfe3=""><a href="/posts" class="router-link-active" title="Blog" data-v-89b7cfe3=""><span class="lt-md:hidden" data-v-89b7cfe3="">博客</span><div i-ri-article-line="" md:hidden="" data-v-89b7cfe3=""></div></a><a href="/projects" class="" title="Projects" data-v-89b7cfe3=""><span class="lt-md:hidden" data-v-89b7cfe3="">项目</span><div i-ri-lightbulb-line="" class="md:hidden" data-v-89b7cfe3=""></div></a><a href="/photos" class="" title="photos" data-v-89b7cfe3=""><span class="lt-md:hidden" data-v-89b7cfe3="">摄影</span><div i-arcticons:photoncamera="" class="md:hidden" data-v-89b7cfe3=""></div></a><a href="https://github.com/ajiu9" target="_blank" title="GitHub" class="lt-md:hidden" data-v-89b7cfe3=""><div i-uil-github-alt="" data-v-89b7cfe3=""></div></a><a href="/feed.xml" target="_blank" title="RSS" class="lt-md:hidden" data-v-89b7cfe3=""><div i-la-rss-square="" style="font-size:1.25rem;margin:0 -.125rem" data-v-89b7cfe3=""></div></a><a class="select-none" title="Toggle Color Scheme" data-v-89b7cfe3=""><div i-ri-sun-line="" dark:i-ri-moon-line=""></div></a></div></nav></header><main class="px-7 py-10 of-x-hidden"><!--[--><!----><div class="prose m-auto mb-8"><h1 class="mb-0 slide-enter-50">在一个项目中同时使用ESM和CJS</h1><p class="opacity-50 !-mt-6 slide-enter-50">Sep 2 <span>· 15min</span></p><!----><!----><!----></div><article class=""><!--[--><div class="prose m-auto slide-enter-content"><h2 id="esm-cjs" tabindex="-1">ESM &amp; CJS <a class="header-anchor" href="#esm-cjs" aria-hidden="true">#</a></h2><p>[[commonjs和esm]]</p><ul><li>ESM - <a href="https://nodejs.org/api/esm.html" target="_blank" rel="noopener">ECMAScript Modules</a></li><li>CJS - <a href="https://nodejs.org/api/modules.html#modules_commonjs_modules" target="_blank" rel="noopener">CommonJS</a></li></ul><p>在过去的十年中，由于缺乏标准的 JavaScript 模块系统，CommonJS（又名“require(‘xxx’)”和“module.exports”语法）一直是 Node.js 和 NPM 包的工作方式。直到 2015 年，当 ECMAScript 模块最终作为标准解决方案出现时，社区开始逐渐迁移到原生 ESM。</p><p>CJS</p><pre class="shiki shiki-themes github-light github-dark" style="--s-light:#24292e;--s-dark:#e1e4e8;--s-light-bg:#fff;--s-dark-bg:#24292e" tabindex="0"><code class="language-js"><span class="line"><span style="--s-light:#6A737D;--s-dark:#6A737D">// addTwo.js</span></span>
=======
<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="author" content="Ajiu9"><meta http-equiv="X-UA-Compatible" content="chrome=1"><meta name="revisit-after" content="7 days"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" href="/favicon.svg" type="image/svg+xml"><link rel="alternate" type="application/rss+xml" title="Ajiu9's Blog" href="/feed.xml"><meta name="msapplication-TileColor" content="#ffffff"><title>在一个项目中同时使用ESM和CJS</title><script>!function(){var e=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,t=localStorage.getItem("vueuse-color-scheme")||"auto";("dark"===t||e&&"light"!==t)&&document.documentElement.classList.toggle("dark",!0)}()</script><script type="module" crossorigin="" src="/assets/app-tsylX9jC.js"></script><link rel="stylesheet" crossorigin="" href="/assets/app-DRnZP3lX.css"><link rel="modulepreload" crossorigin="" href="/assets/publish-esm-and-cjs-ClxHK9Qu.js"><meta property="og:title" content="在一个项目中同时使用ESM和CJS"><meta name="twitter:title" content="在一个项目中同时使用ESM和CJS"><meta name="description" content="在单项目中运行ESM和CJS的简单介绍"><meta property="og:description" content="在单项目中运行ESM和CJS的简单介绍"><meta name="twitter:description" content="在单项目中运行ESM和CJS的简单介绍"><meta property="og:image" content="https://ajiu9.cn/og/publish-esm-and-cjs.png"><meta name="twitter:image" content="https://ajiu9.cn/og/publish-esm-and-cjs.png"><meta name="twitter:card" content="summary_large_image"></head><body class="font-sans text-gray-700 dark:text-gray-200 relative"><div id="app" data-server-rendered="true"><!--[--><header class="header z-40" data-v-89b7cfe3=""><a href="/" class="w-12 h-12 absolute xl:fixed m-5 select-none outline-none" focusable="false" data-v-89b7cfe3=""><svg class="svg" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-89b7cfe3="" data-v-6edbdcb7=""><title data-v-6edbdcb7="">Ajiu9</title><mask id="mask0_634_3" style="mask-type:alpha" width="47" height="80" data-v-6edbdcb7=""><path d="M23.5125 22.9252C33.7594 11.9188 21.3168 -4.95774 7.41017 3.11364C-6.49649 11.185 3.75055 40.5355 23.5125 22.9252ZM23.5125 22.9252C79.8707 -24.0356 12.5336 46.4057 12.5336 69.1523C12.5336 91.8989 36.8153 72.5834 16.9251 38.3343" fill="white" data-v-6edbdcb7=""></path></mask><g mask="url(#mask0_634_3)" data-v-6edbdcb7=""><path class="path1" d="M23.5125 22.9252C33.7594 11.9188 21.3168 -4.95774 7.41017 3.11364C-6.49649 11.185 3.75055 40.5355 23.5125 22.9252ZM23.5125 22.9252C79.8707 -24.0356 12.5336 46.4057 12.5336 69.1523C12.5336 91.8989 36.8153 72.5834 16.9251 38.3343" stroke="black" stroke-width="3.5" stroke-linecap="round" data-v-6edbdcb7=""></path></g></svg></a><button title="Scroll to top" fixed="" right-3="" bottom-3="" w-10="" h-10="" hover:op100="" rounded-full="" hover-bg-hex-8883="" transition="" duration-300="" z-100="" print:hidden="" class="op0! pointer-events-none" data-v-89b7cfe3=""><div i-ri-arrow-up-line="" data-v-89b7cfe3=""></div></button><nav class="nav" data-v-89b7cfe3=""><div class="spacer" data-v-89b7cfe3=""></div><div class="right" print:op0="" data-v-89b7cfe3=""><a href="/posts" class="router-link-active" title="Blog" data-v-89b7cfe3=""><span class="lt-md:hidden" data-v-89b7cfe3="">博客</span><div i-ri-article-line="" md:hidden="" data-v-89b7cfe3=""></div></a><a href="/projects" class="" title="Projects" data-v-89b7cfe3=""><span class="lt-md:hidden" data-v-89b7cfe3="">项目</span><div i-ri-lightbulb-line="" class="md:hidden" data-v-89b7cfe3=""></div></a><a href="/photos" class="" title="photos" data-v-89b7cfe3=""><span class="lt-md:hidden" data-v-89b7cfe3="">摄影</span><div i-arcticons:photoncamera="" class="md:hidden" data-v-89b7cfe3=""></div></a><a href="https://github.com/ajiu9" target="_blank" title="GitHub" class="lt-md:hidden" data-v-89b7cfe3=""><div i-uil-github-alt="" data-v-89b7cfe3=""></div></a><a href="/feed.xml" target="_blank" title="RSS" class="lt-md:hidden" data-v-89b7cfe3=""><div i-la-rss-square="" style="font-size:1.25rem;margin:0 -.125rem" data-v-89b7cfe3=""></div></a><a class="select-none" title="Toggle Color Scheme" data-v-89b7cfe3=""><div i-ri-sun-line="" dark:i-ri-moon-line=""></div></a></div></nav></header><main class="px-7 py-10 of-x-hidden"><!--[--><!----><div class="prose m-auto mb-8"><h1 class="mb-0 slide-enter-50">在一个项目中同时使用ESM和CJS</h1><p class="opacity-50 !-mt-6 slide-enter-50">Sep 2 <span>· 15min</span></p><!----><!----><!----></div><article class=""><!--[--><div class="prose m-auto slide-enter-content"><h2 id="esm-cjs" tabindex="-1">ESM &amp; CJS <a class="header-anchor" href="#esm-cjs" aria-hidden="true">#</a></h2><p>[[commonjs和esm]]</p><ul><li>ESM - <a href="https://nodejs.org/api/esm.html" target="_blank" rel="noopener">ECMAScript Modules</a></li><li>CJS - <a href="https://nodejs.org/api/modules.html#modules_commonjs_modules" target="_blank" rel="noopener">CommonJS</a></li></ul><p>在过去的十年中，由于缺乏标准的 JavaScript 模块系统，CommonJS（又名“require(‘xxx’)”和“module.exports”语法）一直是 Node.js 和 NPM 包的工作方式。直到 2015 年，当 ECMAScript 模块最终作为标准解决方案出现时，社区开始逐渐迁移到原生 ESM。</p><p>CJS</p><pre class="shiki shiki-themes github-light github-dark" style="--s-light:#24292e;--s-dark:#e1e4e8;--s-light-bg:#fff;--s-dark-bg:#24292e" tabindex="0"><code class="language-js"><span class="line"><span style="--s-light:#6A737D;--s-dark:#6A737D">// addTwo.js</span></span>
>>>>>>> release
<span class="line"><span style="--s-light:#D73A49;--s-dark:#F97583">function</span><span style="--s-light:#6F42C1;--s-dark:#B392F0"> addTwo</span><span style="--s-light:#24292E;--s-dark:#E1E4E8">(</span><span style="--s-light:#E36209;--s-dark:#FFAB70">num</span><span style="--s-light:#24292E;--s-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--s-light:#D73A49;--s-dark:#F97583">  return</span><span style="--s-light:#24292E;--s-dark:#E1E4E8"> num </span><span style="--s-light:#D73A49;--s-dark:#F97583">+</span><span style="--s-light:#005CC5;--s-dark:#79B8FF"> 2</span></span>
<span class="line"><span style="--s-light:#24292E;--s-dark:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="--s-light:#005CC5;--s-dark:#79B8FF">module</span><span style="--s-light:#24292E;--s-dark:#E1E4E8">.</span><span style="--s-light:#005CC5;--s-dark:#79B8FF">exports</span><span style="--s-light:#D73A49;--s-dark:#F97583"> =</span><span style="--s-light:#24292E;--s-dark:#E1E4E8"> addTwo</span></span></code></pre><pre class="shiki shiki-themes github-light github-dark" style="--s-light:#24292e;--s-dark:#e1e4e8;--s-light-bg:#fff;--s-dark-bg:#24292e" tabindex="0"><code class="language-js"><span class="line"><span style="--s-light:#6A737D;--s-dark:#6A737D">// app.js</span></span>
<span class="line"><span style="--s-light:#D73A49;--s-dark:#F97583">const</span><span style="--s-light:#005CC5;--s-dark:#79B8FF"> addTwo</span><span style="--s-light:#D73A49;--s-dark:#F97583"> =</span><span style="--s-light:#6F42C1;--s-dark:#B392F0"> require</span><span style="--s-light:#24292E;--s-dark:#E1E4E8">(</span><span style="--s-light:#032F62;--s-dark:#9ECBFF">'./addTwo.js'</span><span style="--s-light:#24292E;--s-dark:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="--s-light:#6A737D;--s-dark:#6A737D">// Prints: 6</span></span>
<span class="line"><span style="--s-light:#24292E;--s-dark:#E1E4E8">console.</span><span style="--s-light:#6F42C1;--s-dark:#B392F0">log</span><span style="--s-light:#24292E;--s-dark:#E1E4E8">(</span><span style="--s-light:#6F42C1;--s-dark:#B392F0">addTwo</span><span style="--s-light:#24292E;--s-dark:#E1E4E8">(</span><span style="--s-light:#005CC5;--s-dark:#79B8FF">4</span><span style="--s-light:#24292E;--s-dark:#E1E4E8">))</span></span></code></pre><p>ESM</p><pre class="shiki shiki-themes github-light github-dark" style="--s-light:#24292e;--s-dark:#e1e4e8;--s-light-bg:#fff;--s-dark-bg:#24292e" tabindex="0"><code class="language-js"><span class="line"><span style="--s-light:#6A737D;--s-dark:#6A737D">// addTwo.mjs</span></span>
<span class="line"><span style="--s-light:#D73A49;--s-dark:#F97583">function</span><span style="--s-light:#6F42C1;--s-dark:#B392F0"> addTwo</span><span style="--s-light:#24292E;--s-dark:#E1E4E8">(</span><span style="--s-light:#E36209;--s-dark:#FFAB70">num</span><span style="--s-light:#24292E;--s-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--s-light:#D73A49;--s-dark:#F97583">  return</span><span style="--s-light:#24292E;--s-dark:#E1E4E8"> num </span><span style="--s-light:#D73A49;--s-dark:#F97583">+</span><span style="--s-light:#005CC5;--s-dark:#79B8FF"> 2</span></span>
<span class="line"><span style="--s-light:#24292E;--s-dark:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="--s-light:#D73A49;--s-dark:#F97583">export</span><span style="--s-light:#24292E;--s-dark:#E1E4E8"> { addTwo }</span></span></code></pre><pre class="shiki shiki-themes github-light github-dark" style="--s-light:#24292e;--s-dark:#e1e4e8;--s-light-bg:#fff;--s-dark-bg:#24292e" tabindex="0"><code class="language-js"><span class="line"><span style="--s-light:#6A737D;--s-dark:#6A737D">// app.mjs</span></span>
<span class="line"><span style="--s-light:#D73A49;--s-dark:#F97583">import</span><span style="--s-light:#24292E;--s-dark:#E1E4E8"> { addTwo } </span><span style="--s-light:#D73A49;--s-dark:#F97583">from</span><span style="--s-light:#032F62;--s-dark:#9ECBFF"> './addTwo.mjs'</span></span>
<span class="line"></span>
<span class="line"><span style="--s-light:#6A737D;--s-dark:#6A737D">// Prints: 6</span></span>
<span class="line"><span style="--s-light:#24292E;--s-dark:#E1E4E8">console.</span><span style="--s-light:#6F42C1;--s-dark:#B392F0">log</span><span style="--s-light:#24292E;--s-dark:#E1E4E8">(</span><span style="--s-light:#6F42C1;--s-dark:#B392F0">addTwo</span><span style="--s-light:#24292E;--s-dark:#E1E4E8">(</span><span style="--s-light:#005CC5;--s-dark:#79B8FF">4</span><span style="--s-light:#24292E;--s-dark:#E1E4E8">))</span></span></code></pre><p>ESM 支持命名导出、更好的静态分析、tree-shaking、浏览器原生支持；最重要的是，作为一个标准，它基本上是 JavaScript 的未来。Node.js v12 中引入了对 ESM 的实验性支持，并在 v12.22.0 和 v14.17.0 中稳定下来。</p><p>截至 2024，很多软件包都提供 ESM 格式或者 CJS 和 ESM 两种格式支持。毕竟nodejs生态庞大，迁移到 ESM 生态是一个长期过程。</p><p>所以对于项目的作者来说，提供两种格式的兼容性，是必要的。在这篇文章中，我将提供一个简单的示例，以解释如何使用 CJS 和 ESM 在同一个项目中同时工作。</p><h2 id="兼容性" tabindex="-1">兼容性 <a class="header-anchor" href="#兼容性" aria-hidden="true">#</a></h2><p>如果 ESM 更好，代表未来，为何不全面转向ESM？尽管Node.js能够兼容CJS和ESM包，但主要障碍在于<strong>CJS无法使用ESM包</strong>。</p><pre class="shiki shiki-themes github-light github-dark" style="--s-light:#24292e;--s-dark:#e1e4e8;--s-light-bg:#fff;--s-dark-bg:#24292e" tabindex="0"><code class="language-js"><span class="line"><span style="--s-light:#6A737D;--s-dark:#6A737D">// app.cjs</span></span>
<span class="line"><span style="--s-light:#D73A49;--s-dark:#F97583">const</span><span style="--s-light:#005CC5;--s-dark:#79B8FF"> pkg</span><span style="--s-light:#D73A49;--s-dark:#F97583"> =</span><span style="--s-light:#6F42C1;--s-dark:#B392F0"> require</span><span style="--s-light:#24292E;--s-dark:#E1E4E8">(</span><span style="--s-light:#032F62;--s-dark:#9ECBFF">'./addTwo-only-esm.mjs'</span><span style="--s-light:#24292E;--s-dark:#E1E4E8">)</span></span></code></pre><pre class="shiki shiki-themes github-light github-dark" style="--s-light:#24292e;--s-dark:#e1e4e8;--s-light-bg:#fff;--s-dark-bg:#24292e" tabindex="0"><code class="language-bash"><span class="line"><span style="--s-light:#6F42C1;--s-dark:#B392F0">Error</span><span style="--s-light:#24292E;--s-dark:#E1E4E8"> [ERR_REQUIRE_ESM]: Must use import to load ES Module: /private/tmp/ajiu9-MiETrR/addTwo-only-esm.mjs</span></span></code></pre><p>根本原因是 ESM 本质上是异步的，你无法在“require”所在的同步上下文中导入异步模块。这通常意味着如果想使用 ESM 软件包，则也必须使用 ESM。 唯一的例外是，可以使用 <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/import#dynamic_imports" target="_blank" rel="noopener">dynamic 'import()'</a> 在 CJS 中使用 ESM 包：</p><pre class="shiki shiki-themes github-light github-dark" style="--s-light:#24292e;--s-dark:#e1e4e8;--s-light-bg:#fff;--s-dark-bg:#24292e" tabindex="0"><code class="language-js"><span class="line"><span style="--s-light:#6A737D;--s-dark:#6A737D">// app.mjs</span></span>
<span class="line"><span style="--s-light:#D73A49;--s-dark:#F97583">async</span><span style="--s-light:#D73A49;--s-dark:#F97583"> function</span><span style="--s-light:#6F42C1;--s-dark:#B392F0"> awaitFunction</span><span style="--s-light:#24292E;--s-dark:#E1E4E8">() {</span></span>
<span class="line"><span style="--s-light:#D73A49;--s-dark:#F97583">  const</span><span style="--s-light:#24292E;--s-dark:#E1E4E8"> { </span><span style="--s-light:#E36209;--s-dark:#FFAB70">default</span><span style="--s-light:#24292E;--s-dark:#E1E4E8">: </span><span style="--s-light:#005CC5;--s-dark:#79B8FF">pkg</span><span style="--s-light:#24292E;--s-dark:#E1E4E8"> } </span><span style="--s-light:#D73A49;--s-dark:#F97583">=</span><span style="--s-light:#D73A49;--s-dark:#F97583"> await</span><span style="--s-light:#D73A49;--s-dark:#F97583"> import</span><span style="--s-light:#24292E;--s-dark:#E1E4E8">(</span><span style="--s-light:#032F62;--s-dark:#9ECBFF">'./addTwo-only-esm.mjs'</span><span style="--s-light:#24292E;--s-dark:#E1E4E8">)</span></span>
<span class="line"><span style="--s-light:#24292E;--s-dark:#E1E4E8">  console.</span><span style="--s-light:#6F42C1;--s-dark:#B392F0">log</span><span style="--s-light:#24292E;--s-dark:#E1E4E8">(pkg)</span></span>
<span class="line"><span style="--s-light:#24292E;--s-dark:#E1E4E8">}</span></span>
<span class="line"><span style="--s-light:#6F42C1;--s-dark:#B392F0">awaitFunction</span><span style="--s-light:#24292E;--s-dark:#E1E4E8">()</span></span></code></pre><p>由于动态导入将返回 Promise，这意味着所有后续被调用者也需要异步。在某些情况下它可能会起作用，但通常这对用户来说不是一个简单易用的解决方案。</p><p>如果你能够直接使用ESM，那会容易得多，因为<code>import</code>同时支持ESM和CJS。</p><pre class="shiki shiki-themes github-light github-dark" style="--s-light:#24292e;--s-dark:#e1e4e8;--s-light-bg:#fff;--s-dark-bg:#24292e" tabindex="0"><code class="language-js"><span class="line"><span style="--s-light:#6A737D;--s-dark:#6A737D">// in ESM</span></span>
<span class="line"><span style="--s-light:#D73A49;--s-dark:#F97583">import</span><span style="--s-light:#24292E;--s-dark:#E1E4E8"> { foo } </span><span style="--s-light:#D73A49;--s-dark:#F97583">from</span><span style="--s-light:#032F62;--s-dark:#9ECBFF"> 'esm-package'</span></span>
<span class="line"><span style="--s-light:#D73A49;--s-dark:#F97583">import</span><span style="--s-light:#24292E;--s-dark:#E1E4E8"> cjs </span><span style="--s-light:#D73A49;--s-dark:#F97583">from</span><span style="--s-light:#032F62;--s-dark:#9ECBFF"> 'cjs-package'</span></span></code></pre><p>一些软件包现在提供纯ESM版本，倡导从CJS转向ESM。尽管这是趋势，但由于大多数项目仍在使用CJS且迁移不易，我选择同时发布CJS和ESM版本，以使过渡更加平滑。</p><h3 id="package-json" tabindex="-1"><code>package.json</code> <a class="header-anchor" href="#package-json" aria-hidden="true">#</a></h3><p>幸运的是，Node 允许你在同一个软件包中同时使用这两种格式。通过 <code>package.json</code> 中的新 <a href="https://nodejs.org/api/packages.html#conditional-exports" target="_blank" rel="noopener"><code>exports</code></a> 字段，提供了一种根据特定条件映射到不同路径的方法。它们支持 CommonJS 和 ES 模块导入。</p><pre class="shiki shiki-themes github-light github-dark" style="--s-light:#24292e;--s-dark:#e1e4e8;--s-light-bg:#fff;--s-dark-bg:#24292e" tabindex="0"><code class="language-js"><span class="line"><span style="--s-light:#24292E;--s-dark:#E1E4E8">{</span></span>
<span class="line"><span style="--s-light:#032F62;--s-dark:#9ECBFF">  "exports"</span><span style="--s-light:#24292E;--s-dark:#E1E4E8">: {</span></span>
<span class="line"><span style="--s-light:#032F62;--s-dark:#9ECBFF">    "node"</span><span style="--s-light:#24292E;--s-dark:#E1E4E8">: {</span></span>
<span class="line"><span style="--s-light:#032F62;--s-dark:#9ECBFF">      "import"</span><span style="--s-light:#24292E;--s-dark:#E1E4E8">: </span><span style="--s-light:#032F62;--s-dark:#9ECBFF">"./feature-node.mjs"</span><span style="--s-light:#24292E;--s-dark:#E1E4E8">, </span><span style="--s-light:#6A737D;--s-dark:#6A737D">// EMS</span></span>
<span class="line"><span style="--s-light:#032F62;--s-dark:#9ECBFF">      "require"</span><span style="--s-light:#24292E;--s-dark:#E1E4E8">: </span><span style="--s-light:#032F62;--s-dark:#9ECBFF">"./feature-node.cjs"</span><span style="--s-light:#6A737D;--s-dark:#6A737D"> // CJS</span></span>
<span class="line"><span style="--s-light:#24292E;--s-dark:#E1E4E8">    },</span></span>
<span class="line"><span style="--s-light:#032F62;--s-dark:#9ECBFF">    "default"</span><span style="--s-light:#24292E;--s-dark:#E1E4E8">: </span><span style="--s-light:#032F62;--s-dark:#9ECBFF">"./feature.mjs"</span></span>
<span class="line"><span style="--s-light:#24292E;--s-dark:#E1E4E8">  }</span></span>
<span class="line"><span style="--s-light:#24292E;--s-dark:#E1E4E8">}</span></span></code></pre><h2 id="打包" tabindex="-1">打包 <a class="header-anchor" href="#打包" aria-hidden="true">#</a></h2><p>如果需要支持两种模块方式，复制两份代码肯定不是一个好的解决方案。此时，我们需要考虑引入一些构建工具或打包工具。比如 <a href="https://rollupjs.org/" target="_blank" rel="noopener">Rollup</a> 和 <a href="https://webpack.js.org/" target="_blank" rel="noopener">Webpack</a>。将你的代码构建成多种格式。但是它们的配置很复杂，需要花很多时间去学习。这里有两个非常棒的工具，它们只需要简单的配置就可以工作。</p><ul><li><a href="#tsup"><code>tsup</code></a></li><li><a href="#unbuild"><code>unbuild</code></a></li></ul><h3 id="tsup" tabindex="-1">tsup <a class="header-anchor" href="#tsup" aria-hidden="true">#</a></h3><p><a href="https://github.com/egoist/tsup" target="_blank" rel="noopener"><code>tsup</code></a>它具有零配置构建 TypeScript 项目的特点。使用方法如下：</p><pre class="shiki shiki-themes github-light github-dark" style="--s-light:#24292e;--s-dark:#e1e4e8;--s-light-bg:#fff;--s-dark-bg:#24292e" tabindex="0"><code class="language-bash"><span class="line"><span style="--s-light:#6F42C1;--s-dark:#B392F0">tsup</span><span style="--s-light:#032F62;--s-dark:#9ECBFF"> src/index.ts</span></span></code></pre><p>它将输出一个 <code>dist/index.js</code> 文件。</p><p>若要支持双格式，只需添加一个标志即可：</p><pre class="shiki shiki-themes github-light github-dark" style="--s-light:#24292e;--s-dark:#e1e4e8;--s-light-bg:#fff;--s-dark-bg:#24292e" tabindex="0"><code class="language-bash"><span class="line"><span style="--s-light:#6F42C1;--s-dark:#B392F0">$</span><span style="--s-light:#032F62;--s-dark:#9ECBFF"> tsup</span><span style="--s-light:#032F62;--s-dark:#9ECBFF"> src/index.ts</span><span style="--s-light:#005CC5;--s-dark:#79B8FF"> --format</span><span style="--s-light:#032F62;--s-dark:#9ECBFF"> cjs,esm</span></span></code></pre><p>使用该工具会生成两个文件 <code>dist/index.js</code> 和 <code>dist/index.mjs</code>，之后你就可以直接使用了。由于采用了 <a href="https://github.com/evanw/esbuild" target="_blank" rel="noopener"><code>esbuild</code></a>，<code>tsup</code> 不仅非常易用，而且速度惊人。</p><p>这是一个使用<code>tsup</code>的<code>package.json</code>模版配置。</p><pre class="shiki shiki-themes github-light github-dark" style="--s-light:#24292e;--s-dark:#e1e4e8;--s-light-bg:#fff;--s-dark-bg:#24292e" tabindex="0"><code class="language-json"><span class="line"><span style="--s-light:#24292E;--s-dark:#E1E4E8">{</span></span>
<span class="line"><span style="--s-light:#005CC5;--s-dark:#79B8FF">  "name"</span><span style="--s-light:#24292E;--s-dark:#E1E4E8">: </span><span style="--s-light:#032F62;--s-dark:#9ECBFF">"pakage-name"</span><span style="--s-light:#24292E;--s-dark:#E1E4E8">,</span></span>
<span class="line"><span style="--s-light:#005CC5;--s-dark:#79B8FF">  "main"</span><span style="--s-light:#24292E;--s-dark:#E1E4E8">: </span><span style="--s-light:#032F62;--s-dark:#9ECBFF">"./dist/index.js"</span><span style="--s-light:#24292E;--s-dark:#E1E4E8">,</span></span>
<span class="line"><span style="--s-light:#005CC5;--s-dark:#79B8FF">  "module"</span><span style="--s-light:#24292E;--s-dark:#E1E4E8">: </span><span style="--s-light:#032F62;--s-dark:#9ECBFF">"./dist/index.mjs"</span><span style="--s-light:#24292E;--s-dark:#E1E4E8">,</span></span>
<span class="line"><span style="--s-light:#005CC5;--s-dark:#79B8FF">  "types"</span><span style="--s-light:#24292E;--s-dark:#E1E4E8">: </span><span style="--s-light:#032F62;--s-dark:#9ECBFF">"./dist/index.d.ts"</span><span style="--s-light:#24292E;--s-dark:#E1E4E8">,</span></span>
<span class="line"><span style="--s-light:#005CC5;--s-dark:#79B8FF">  "exports"</span><span style="--s-light:#24292E;--s-dark:#E1E4E8">: {</span></span>
<span class="line"><span style="--s-light:#005CC5;--s-dark:#79B8FF">    "."</span><span style="--s-light:#24292E;--s-dark:#E1E4E8">: {</span></span>
<span class="line"><span style="--s-light:#005CC5;--s-dark:#79B8FF">      "require"</span><span style="--s-light:#24292E;--s-dark:#E1E4E8">: </span><span style="--s-light:#032F62;--s-dark:#9ECBFF">"./dist/index.js"</span><span style="--s-light:#24292E;--s-dark:#E1E4E8">,</span></span>
<span class="line"><span style="--s-light:#005CC5;--s-dark:#79B8FF">      "import"</span><span style="--s-light:#24292E;--s-dark:#E1E4E8">: </span><span style="--s-light:#032F62;--s-dark:#9ECBFF">"./dist/index.mjs"</span><span style="--s-light:#24292E;--s-dark:#E1E4E8">,</span></span>
<span class="line"><span style="--s-light:#005CC5;--s-dark:#79B8FF">      "types"</span><span style="--s-light:#24292E;--s-dark:#E1E4E8">: </span><span style="--s-light:#032F62;--s-dark:#9ECBFF">"./dist/index.d.ts"</span></span>
<span class="line"><span style="--s-light:#24292E;--s-dark:#E1E4E8">    }</span></span>
<span class="line"><span style="--s-light:#24292E;--s-dark:#E1E4E8">  },</span></span>
<span class="line"><span style="--s-light:#005CC5;--s-dark:#79B8FF">  "scripts"</span><span style="--s-light:#24292E;--s-dark:#E1E4E8">: {</span></span>
<span class="line"><span style="--s-light:#005CC5;--s-dark:#79B8FF">    "build"</span><span style="--s-light:#24292E;--s-dark:#E1E4E8">: </span><span style="--s-light:#032F62;--s-dark:#9ECBFF">"tsup src/index.ts --format cjs,esm --dts --clean"</span><span style="--s-light:#24292E;--s-dark:#E1E4E8">,</span></span>
<span class="line"><span style="--s-light:#005CC5;--s-dark:#79B8FF">    "watch"</span><span style="--s-light:#24292E;--s-dark:#E1E4E8">: </span><span style="--s-light:#032F62;--s-dark:#9ECBFF">"npm run build -- --watch src"</span><span style="--s-light:#24292E;--s-dark:#E1E4E8">,</span></span>
<span class="line"><span style="--s-light:#005CC5;--s-dark:#79B8FF">    "prepublishOnly"</span><span style="--s-light:#24292E;--s-dark:#E1E4E8">: </span><span style="--s-light:#032F62;--s-dark:#9ECBFF">"npm run build"</span></span>
<span class="line"><span style="--s-light:#24292E;--s-dark:#E1E4E8">  }</span></span>
<span class="line"><span style="--s-light:#24292E;--s-dark:#E1E4E8">}</span></span></code></pre><h3 id="unbuild" tabindex="-1">unbuild <a class="header-anchor" href="#unbuild" aria-hidden="true">#</a></h3><p><code>tsup</code> 是一个轻量级的 TypeScript 打包工具，而<a href="https://github.com/unjs/unbuild" target="_blank" rel="noopener"><code>unbuild</code></a> 则更加通用、可定制且功能强大。</p><p>要使用它，我们需要在根目录下创建 <code>build.config.ts</code> 文件。</p><pre class="shiki shiki-themes github-light github-dark" style="--s-light:#24292e;--s-dark:#e1e4e8;--s-light-bg:#fff;--s-dark-bg:#24292e" tabindex="0"><code class="language-ts"><span class="line"><span style="--s-light:#6A737D;--s-dark:#6A737D">// build.config.ts</span></span>
<span class="line"><span style="--s-light:#D73A49;--s-dark:#F97583">import</span><span style="--s-light:#24292E;--s-dark:#E1E4E8"> { defineBuildConfig } </span><span style="--s-light:#D73A49;--s-dark:#F97583">from</span><span style="--s-light:#032F62;--s-dark:#9ECBFF"> 'unbuild'</span></span>
<span class="line"></span>
<span class="line"><span style="--s-light:#D73A49;--s-dark:#F97583">export</span><span style="--s-light:#D73A49;--s-dark:#F97583"> default</span><span style="--s-light:#6F42C1;--s-dark:#B392F0"> defineBuildConfig</span><span style="--s-light:#24292E;--s-dark:#E1E4E8">({</span></span>
<span class="line"><span style="--s-light:#24292E;--s-dark:#E1E4E8">  entries: [</span></span>
<span class="line"><span style="--s-light:#032F62;--s-dark:#9ECBFF">    './src/index'</span></span>
<span class="line"><span style="--s-light:#24292E;--s-dark:#E1E4E8">  ],</span></span>
<span class="line"><span style="--s-light:#24292E;--s-dark:#E1E4E8">  declaration: </span><span style="--s-light:#005CC5;--s-dark:#79B8FF">true</span><span style="--s-light:#24292E;--s-dark:#E1E4E8">, </span><span style="--s-light:#6A737D;--s-dark:#6A737D">// 生成 .d.ts files</span></span>
<span class="line"><span style="--s-light:#24292E;--s-dark:#E1E4E8">})</span></span></code></pre><p>然后运行构建命令：</p><pre class="shiki shiki-themes github-light github-dark" style="--s-light:#24292e;--s-dark:#e1e4e8;--s-light-bg:#fff;--s-dark-bg:#24292e" tabindex="0"><code class="language-bash"><span class="line"><span style="--s-light:#6F42C1;--s-dark:#B392F0">$</span><span style="--s-light:#032F62;--s-dark:#9ECBFF"> unbuild</span></span></code></pre><p>默认情况下，“unbuild”将生成ESM和CJS！</p><h2 id="上下文差异" tabindex="-1">上下文差异 <a class="header-anchor" href="#上下文差异" aria-hidden="true">#</a></h2><p>使用上述工具，我们现在能够将 TypeScript 作为唯一的代码源，同时生成 CJS 和 ESM 模块，使整体代码库更容易维护，但仍然有一些需要注意的细节。</p><p><strong>在 ESM 中，没有 <code>__dirname</code>, <code>__filename</code>, <code>require</code>, <code>require.resolve</code></strong>。需要使用 <code>import.meta.url</code> 并做一些转换来获取文件路径字符串。</p><p>由于我们的代码将被编译为 CJS 和 ESM，尽量避免使用这些特定于环境的上下文。如果确实需要，可以参考以下代码：</p><pre class="shiki shiki-themes github-light github-dark" style="--s-light:#24292e;--s-dark:#e1e4e8;--s-light-bg:#fff;--s-dark-bg:#24292e" tabindex="0"><code class="language-ts"><span class="line"><span style="--s-light:#D73A49;--s-dark:#F97583">import</span><span style="--s-light:#24292E;--s-dark:#E1E4E8"> { dirname } </span><span style="--s-light:#D73A49;--s-dark:#F97583">from</span><span style="--s-light:#032F62;--s-dark:#9ECBFF"> 'node:path'</span></span>
<span class="line"><span style="--s-light:#D73A49;--s-dark:#F97583">import</span><span style="--s-light:#24292E;--s-dark:#E1E4E8"> { fileURLToPath } </span><span style="--s-light:#D73A49;--s-dark:#F97583">from</span><span style="--s-light:#032F62;--s-dark:#9ECBFF"> 'node:url'</span></span>
<span class="line"></span>
<span class="line"><span style="--s-light:#D73A49;--s-dark:#F97583">const</span><span style="--s-light:#005CC5;--s-dark:#79B8FF"> _dirname</span><span style="--s-light:#D73A49;--s-dark:#F97583"> =</span><span style="--s-light:#D73A49;--s-dark:#F97583"> typeof</span><span style="--s-light:#24292E;--s-dark:#E1E4E8"> __dirname </span><span style="--s-light:#D73A49;--s-dark:#F97583">!==</span><span style="--s-light:#032F62;--s-dark:#9ECBFF"> 'undefined'</span></span>
<span class="line"><span style="--s-light:#D73A49;--s-dark:#F97583">  ?</span><span style="--s-light:#24292E;--s-dark:#E1E4E8"> __dirname</span></span>
<span class="line"><span style="--s-light:#D73A49;--s-dark:#F97583">  :</span><span style="--s-light:#6F42C1;--s-dark:#B392F0"> dirname</span><span style="--s-light:#24292E;--s-dark:#E1E4E8">(</span><span style="--s-light:#6F42C1;--s-dark:#B392F0">fileURLToPath</span><span style="--s-light:#24292E;--s-dark:#E1E4E8">(</span><span style="--s-light:#D73A49;--s-dark:#F97583">import</span><span style="--s-light:#24292E;--s-dark:#E1E4E8">.</span><span style="--s-light:#005CC5;--s-dark:#79B8FF">meta</span><span style="--s-light:#24292E;--s-dark:#E1E4E8">.url))</span></span></code></pre><p>关于 require 和 require.resolve，你可以使用：</p><pre class="shiki shiki-themes github-light github-dark" style="--s-light:#24292e;--s-dark:#e1e4e8;--s-light-bg:#fff;--s-dark-bg:#24292e" tabindex="0"><code class="language-ts"><span class="line"><span style="--s-light:#D73A49;--s-dark:#F97583">import</span><span style="--s-light:#24292E;--s-dark:#E1E4E8"> { createRequire } </span><span style="--s-light:#D73A49;--s-dark:#F97583">from</span><span style="--s-light:#032F62;--s-dark:#9ECBFF"> 'node:module'</span></span>
<span class="line"></span>
<span class="line"><span style="--s-light:#D73A49;--s-dark:#F97583">const</span><span style="--s-light:#005CC5;--s-dark:#79B8FF"> require</span><span style="--s-light:#D73A49;--s-dark:#F97583"> =</span><span style="--s-light:#6F42C1;--s-dark:#B392F0"> createRequire</span><span style="--s-light:#24292E;--s-dark:#E1E4E8">(</span><span style="--s-light:#D73A49;--s-dark:#F97583">import</span><span style="--s-light:#24292E;--s-dark:#E1E4E8">.</span><span style="--s-light:#005CC5;--s-dark:#79B8FF">meta</span><span style="--s-light:#24292E;--s-dark:#E1E4E8">.url)</span></span></code></pre><p><code>如果你使用</code>unbuild<code>，可以开启</code>cjsBridge<code>标志，</code>unbuild` 会自动为你在 ESM 中模拟这些 CJS 上下文！</p><pre class="shiki shiki-themes github-light github-dark" style="--s-light:#24292e;--s-dark:#e1e4e8;--s-light-bg:#fff;--s-dark-bg:#24292e" tabindex="0"><code class="language-ts"><span class="line"><span style="--s-light:#D73A49;--s-dark:#F97583">import</span><span style="--s-light:#24292E;--s-dark:#E1E4E8"> { defineBuildConfig } </span><span style="--s-light:#D73A49;--s-dark:#F97583">from</span><span style="--s-light:#032F62;--s-dark:#9ECBFF"> 'unbuild'</span></span>
<span class="line"></span>
<span class="line"><span style="--s-light:#D73A49;--s-dark:#F97583">export</span><span style="--s-light:#D73A49;--s-dark:#F97583"> default</span><span style="--s-light:#6F42C1;--s-dark:#B392F0"> defineBuildConfig</span><span style="--s-light:#24292E;--s-dark:#E1E4E8">({</span></span>
<span class="line"><span style="--s-light:#24292E;--s-dark:#E1E4E8">  cjsBridge: </span><span style="--s-light:#005CC5;--s-dark:#79B8FF">true</span><span style="--s-light:#24292E;--s-dark:#E1E4E8">, </span><span style="--s-light:#6A737D;--s-dark:#6A737D">// &lt;--</span></span>
<span class="line"><span style="--s-light:#24292E;--s-dark:#E1E4E8">})</span></span></code></pre><p>另外，如果你使用 <code>tsup</code>，它会在 CJS 中为你模拟 ESM 的 <code>import.meta.url</code>。</p><h2 id="验证你的包" tabindex="-1">验证你的包 <a class="header-anchor" href="#验证你的包" aria-hidden="true">#</a></h2><p>一旦你发布了你的包，可以使用 <a href="https://publint.dev/" target="_blank" rel="noopener">publint.dev</a>（由 <a href="https://github.com/bluwy" target="_blank" rel="noopener">@bluwy</a> 制作）来验证它是否遵循最佳实践。它还会给你一些如何进一步改进的建议。</p><h2 id="最后" tabindex="-1">最后 <a class="header-anchor" href="#最后" aria-hidden="true">#</a></h2><p>这篇文章很大部分是参考了<a href="https://antfu.me/posts/publish-esm-and-cjs" target="_blank" rel="noopener">publish-esm-and-cjs</a>。同时这两种工具的使用也只是一部分，请查看它们的文档以获取更多详细信息。希望这些设置对你构建自己的库有所帮助，祝你编程愉快！</p></div><!--]--></article><div class="prose m-auto mt-8 mb-8 slide-enter animate-delay-500 print:hidden"><!--[--><span font-mono="" op50="">&gt; </span><span op50="">comment on </span><a href="https://elk.zone/intent/post?text=Reading%20%40ajiu9%40m.webtoo.ls's%20https%3A%2F%2Fajiu9.cn%2Fposts%2Fpublish-esm-and-cjs%0A%0AI%20think..." target="_blank" op50="">mastodon</a><span op25=""> / </span><a href="https://twitter.com/intent/tweet?text=Reading%20%40ajiu9's%20https%3A%2F%2Fajiu9.cn%2Fposts%2Fpublish-esm-and-cjs%0A%0AI%20think..." target="_blank" op50="">twitter</a><!--]--><br><span font-mono="" op50="">&gt; </span><a href="/posts" class="router-link-active font-mono op50 hover:op75"></a></div><!--]--><div class="mt-10 mb-6 prose m-auto flex slide-enter animate-delay-1200!"><span class="text-sm op50">@2024-2025 湘ICP备2024048835号</span><div class="flex-auto"></div></div></main><!----><!--]--></div></body></html>