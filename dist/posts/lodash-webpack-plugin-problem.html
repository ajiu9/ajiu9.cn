<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="author" content="Ajiu9"><meta http-equiv="X-UA-Compatible" content="chrome=1"><meta name="revisit-after" content="7 days"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" href="/favicon.svg" type="image/svg+xml"><link rel="alternate" type="application/rss+xml" title="Ajiu9's Blog" href="/feed.xml"><meta name="msapplication-TileColor" content="#ffffff"><title>排除一个在开发环境下Lodash的问题</title><script>!function(){var e=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,t=localStorage.getItem("vueuse-color-scheme")||"auto";("dark"===t||e&&"light"!==t)&&document.documentElement.classList.toggle("dark",!0)}()</script><script type="module" crossorigin="" src="/assets/app-DU8umUyc.js"></script><link rel="stylesheet" crossorigin="" href="/assets/app-CuNpTI83.css"><link rel="modulepreload" crossorigin="" href="/assets/lodash-webpack-plugin-problem-BaZKVB0f.js"><meta property="og:title" content="排除一个在开发环境下Lodash的问题"><meta name="twitter:title" content="排除一个在开发环境下Lodash的问题"><meta property="og:image" content="https://ajiu9.cn/og/lodash-webpack-plugin-problem.png"><meta name="twitter:image" content="https://ajiu9.cn/og/lodash-webpack-plugin-problem.png"><meta name="twitter:card" content="summary_large_image"></head><body class="font-sans text-gray-700 dark:text-gray-200 relative"><div id="app" data-server-rendered="true"><!--[--><header class="header z-40" data-v-89b7cfe3=""><a href="/" class="w-12 h-12 absolute xl:fixed m-5 select-none outline-none" focusable="false" data-v-89b7cfe3=""><svg class="svg" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-89b7cfe3="" data-v-6edbdcb7=""><title data-v-6edbdcb7="">Ajiu9</title><mask id="mask0_634_3" style="mask-type:alpha" width="47" height="80" data-v-6edbdcb7=""><path d="M23.5125 22.9252C33.7594 11.9188 21.3168 -4.95774 7.41017 3.11364C-6.49649 11.185 3.75055 40.5355 23.5125 22.9252ZM23.5125 22.9252C79.8707 -24.0356 12.5336 46.4057 12.5336 69.1523C12.5336 91.8989 36.8153 72.5834 16.9251 38.3343" fill="white" data-v-6edbdcb7=""></path></mask><g mask="url(#mask0_634_3)" data-v-6edbdcb7=""><path class="path1" d="M23.5125 22.9252C33.7594 11.9188 21.3168 -4.95774 7.41017 3.11364C-6.49649 11.185 3.75055 40.5355 23.5125 22.9252ZM23.5125 22.9252C79.8707 -24.0356 12.5336 46.4057 12.5336 69.1523C12.5336 91.8989 36.8153 72.5834 16.9251 38.3343" stroke="black" stroke-width="3.5" stroke-linecap="round" data-v-6edbdcb7=""></path></g></svg></a><button title="Scroll to top" fixed="" right-3="" bottom-3="" w-10="" h-10="" hover:op100="" rounded-full="" hover-bg-hex-8883="" transition="" duration-300="" z-100="" print:hidden="" class="op0! pointer-events-none" data-v-89b7cfe3=""><div i-ri-arrow-up-line="" data-v-89b7cfe3=""></div></button><nav class="nav" data-v-89b7cfe3=""><div class="spacer" data-v-89b7cfe3=""></div><div class="right" print:op0="" data-v-89b7cfe3=""><a href="/posts" class="router-link-active" title="Blog" data-v-89b7cfe3=""><span class="lt-md:hidden" data-v-89b7cfe3="">博客</span><div i-ri-article-line="" md:hidden="" data-v-89b7cfe3=""></div></a><a href="/projects" class="" title="Projects" data-v-89b7cfe3=""><span class="lt-md:hidden" data-v-89b7cfe3="">项目</span><div i-ri-lightbulb-line="" class="md:hidden" data-v-89b7cfe3=""></div></a><a href="/photos" class="" title="photos" data-v-89b7cfe3=""><span class="lt-md:hidden" data-v-89b7cfe3="">摄影</span><div i-arcticons:photoncamera="" class="md:hidden" data-v-89b7cfe3=""></div></a><a href="https://github.com/ajiu9" target="_blank" title="GitHub" class="lt-md:hidden" data-v-89b7cfe3=""><div i-uil-github-alt="" data-v-89b7cfe3=""></div></a><a href="/feed.xml" target="_blank" title="RSS" class="lt-md:hidden" data-v-89b7cfe3=""><div i-la-rss-square="" style="font-size:1.25rem;margin:0 -.125rem" data-v-89b7cfe3=""></div></a><a class="select-none" title="Toggle Color Scheme" data-v-89b7cfe3=""><div i-ri-sun-line="" dark:i-ri-moon-line=""></div></a></div></nav></header><main class="px-7 py-10 of-x-hidden"><!--[--><!----><div class="prose m-auto mb-8"><h1 class="mb-0 slide-enter-50">排除一个在开发环境下Lodash的问题</h1><p class="opacity-50 !-mt-6 slide-enter-50">Apr 11<!----></p><!----><!----><!----></div><article class=""><!--[--><div class="prose m-auto slide-enter-content"><blockquote><p>今天同事在开发环境运行时候，发现lodash的cloneDeep方法返回的数组对象是同一个对象，没有进行深拷贝，这种反直觉的行为必然是发生了什么。</p></blockquote><p>首先我想到的是是否是全局参数配置引起的，我看了<a href="https://lodash.com/docs/4.17.15#cloneDeep" target="_blank" rel="noopener">deepClone</a>的文档,发现只有一个入参。</p><p>然后我看了下<a href="https://github.com/lodash/lodash/blob/main/src/cloneDeep.ts" target="_blank" rel="noopener">源码</a>，也没有可以配置的参数。</p><pre class="shiki shiki-themes github-light github-dark" style="--s-light:#24292e;--s-dark:#e1e4e8;--s-light-bg:#fff;--s-dark-bg:#24292e" tabindex="0"><code class="language-js"><span class="line"><span style="--s-light:#D73A49;--s-dark:#F97583">import</span><span style="--s-light:#24292E;--s-dark:#E1E4E8"> baseClone </span><span style="--s-light:#D73A49;--s-dark:#F97583">from</span><span style="--s-light:#032F62;--s-dark:#9ECBFF"> './.internal/baseClone.js'</span></span>
<span class="line"></span>
<span class="line"><span style="--s-light:#6A737D;--s-dark:#6A737D">/** Used to compose bitmasks for cloning. */</span></span>
<span class="line"><span style="--s-light:#D73A49;--s-dark:#F97583">const</span><span style="--s-light:#005CC5;--s-dark:#79B8FF"> CLONE_DEEP_FLAG</span><span style="--s-light:#D73A49;--s-dark:#F97583"> =</span><span style="--s-light:#005CC5;--s-dark:#79B8FF"> 1</span></span>
<span class="line"><span style="--s-light:#D73A49;--s-dark:#F97583">const</span><span style="--s-light:#005CC5;--s-dark:#79B8FF"> CLONE_SYMBOLS_FLAG</span><span style="--s-light:#D73A49;--s-dark:#F97583"> =</span><span style="--s-light:#005CC5;--s-dark:#79B8FF"> 4</span></span>
<span class="line"></span>
<span class="line"><span style="--s-light:#6A737D;--s-dark:#6A737D">/**</span></span>
<span class="line"><span style="--s-light:#6A737D;--s-dark:#6A737D"> * This method is like `clone` except that it recursively clones `value`.</span></span>
<span class="line"><span style="--s-light:#6A737D;--s-dark:#6A737D"> * Object inheritance is preserved.</span></span>
<span class="line"><span style="--s-light:#6A737D;--s-dark:#6A737D"> *</span></span>
<span class="line"><span style="--s-light:#6A737D;--s-dark:#6A737D"> * </span><span style="--s-light:#D73A49;--s-dark:#F97583">@since</span><span style="--s-light:#6A737D;--s-dark:#6A737D"> 1.0.0</span></span>
<span class="line"><span style="--s-light:#6A737D;--s-dark:#6A737D"> * </span><span style="--s-light:#D73A49;--s-dark:#F97583">@category</span><span style="--s-light:#6A737D;--s-dark:#6A737D"> Lang</span></span>
<span class="line"><span style="--s-light:#6A737D;--s-dark:#6A737D"> * </span><span style="--s-light:#D73A49;--s-dark:#F97583">@param</span><span style="--s-light:#6F42C1;--s-dark:#B392F0"> {*}</span><span style="--s-light:#24292E;--s-dark:#E1E4E8"> value</span><span style="--s-light:#6A737D;--s-dark:#6A737D"> The value to recursively clone.</span></span>
<span class="line"><span style="--s-light:#6A737D;--s-dark:#6A737D"> * </span><span style="--s-light:#D73A49;--s-dark:#F97583">@returns</span><span style="--s-light:#6F42C1;--s-dark:#B392F0"> {*}</span><span style="--s-light:#6A737D;--s-dark:#6A737D"> Returns the deep cloned value.</span></span>
<span class="line"><span style="--s-light:#6A737D;--s-dark:#6A737D"> * </span><span style="--s-light:#D73A49;--s-dark:#F97583">@see</span><span style="--s-light:#6F42C1;--s-dark:#B392F0"> clone</span></span>
<span class="line"><span style="--s-light:#6A737D;--s-dark:#6A737D"> * </span><span style="--s-light:#D73A49;--s-dark:#F97583">@example</span></span>
<span class="line"><span style="--s-light:#6A737D;--s-dark:#6A737D"> *</span></span>
<span class="line"><span style="--s-light:#6A737D;--s-dark:#6A737D"> * const objects = [{ 'a': 1 }, { 'b': 2 }]</span></span>
<span class="line"><span style="--s-light:#6A737D;--s-dark:#6A737D"> *</span></span>
<span class="line"><span style="--s-light:#6A737D;--s-dark:#6A737D"> * const deep = cloneDeep(objects)</span></span>
<span class="line"><span style="--s-light:#6A737D;--s-dark:#6A737D"> * console.log(deep[0] === objects[0])</span></span>
<span class="line"><span style="--s-light:#6A737D;--s-dark:#6A737D"> * // =&gt; false</span></span>
<span class="line"><span style="--s-light:#6A737D;--s-dark:#6A737D"> */</span></span>
<span class="line"><span style="--s-light:#D73A49;--s-dark:#F97583">function</span><span style="--s-light:#6F42C1;--s-dark:#B392F0"> cloneDeep</span><span style="--s-light:#24292E;--s-dark:#E1E4E8">(</span><span style="--s-light:#E36209;--s-dark:#FFAB70">value</span><span style="--s-light:#24292E;--s-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--s-light:#D73A49;--s-dark:#F97583">  return</span><span style="--s-light:#6F42C1;--s-dark:#B392F0"> baseClone</span><span style="--s-light:#24292E;--s-dark:#E1E4E8">(value, </span><span style="--s-light:#005CC5;--s-dark:#79B8FF">CLONE_DEEP_FLAG</span><span style="--s-light:#D73A49;--s-dark:#F97583"> |</span><span style="--s-light:#005CC5;--s-dark:#79B8FF"> CLONE_SYMBOLS_FLAG</span><span style="--s-light:#24292E;--s-dark:#E1E4E8">)</span></span>
<span class="line"><span style="--s-light:#24292E;--s-dark:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="--s-light:#D73A49;--s-dark:#F97583">export</span><span style="--s-light:#D73A49;--s-dark:#F97583"> default</span><span style="--s-light:#24292E;--s-dark:#E1E4E8"> cloneDeep</span></span></code></pre><p>没找到问题所在，我调试了下面这段代码</p><pre class="shiki shiki-themes github-light github-dark" style="--s-light:#24292e;--s-dark:#e1e4e8;--s-light-bg:#fff;--s-dark-bg:#24292e" tabindex="0"><code class="language-js"><span class="line"><span style="--s-light:#D73A49;--s-dark:#F97583">import</span><span style="--s-light:#24292E;--s-dark:#E1E4E8"> { cloneDeep } </span><span style="--s-light:#D73A49;--s-dark:#F97583">from</span><span style="--s-light:#032F62;--s-dark:#9ECBFF"> 'lodash'</span></span>
<span class="line"><span style="--s-light:#D73A49;--s-dark:#F97583">const</span><span style="--s-light:#005CC5;--s-dark:#79B8FF"> test1</span><span style="--s-light:#D73A49;--s-dark:#F97583"> =</span><span style="--s-light:#24292E;--s-dark:#E1E4E8"> [{ id: </span><span style="--s-light:#005CC5;--s-dark:#79B8FF">1</span><span style="--s-light:#24292E;--s-dark:#E1E4E8">, name: </span><span style="--s-light:#032F62;--s-dark:#9ECBFF">'测试1'</span><span style="--s-light:#24292E;--s-dark:#E1E4E8"> }]</span></span>
<span class="line"><span style="--s-light:#D73A49;--s-dark:#F97583">const</span><span style="--s-light:#005CC5;--s-dark:#79B8FF"> deep</span><span style="--s-light:#D73A49;--s-dark:#F97583"> =</span><span style="--s-light:#6F42C1;--s-dark:#B392F0"> cloneDeep</span><span style="--s-light:#24292E;--s-dark:#E1E4E8">(test1)</span></span>
<span class="line"><span style="--s-light:#24292E;--s-dark:#E1E4E8">console.</span><span style="--s-light:#6F42C1;--s-dark:#B392F0">log</span><span style="--s-light:#24292E;--s-dark:#E1E4E8">(deep[</span><span style="--s-light:#005CC5;--s-dark:#79B8FF">0</span><span style="--s-light:#24292E;--s-dark:#E1E4E8">] </span><span style="--s-light:#D73A49;--s-dark:#F97583">===</span><span style="--s-light:#24292E;--s-dark:#E1E4E8"> test1[</span><span style="--s-light:#005CC5;--s-dark:#79B8FF">0</span><span style="--s-light:#24292E;--s-dark:#E1E4E8">]) </span><span style="--s-light:#6A737D;--s-dark:#6A737D">// true</span></span></code></pre><p><img src="https://static.ajiu9.cn/images/20240411170613.png" alt="image"></p><p>发现原本<code>cloneDeep</code>依赖了<code>baseClone</code>函数，但是却变成了<a href="https://lodash.com/docs/4.17.15#identity" target="_blank" rel="noopener">identity</a>这个函数就是返回函数的第一个参数。</p><pre class="shiki shiki-themes github-light github-dark" style="--s-light:#24292e;--s-dark:#e1e4e8;--s-light-bg:#fff;--s-dark-bg:#24292e" tabindex="0"><code class="language-js"><span class="line"><span style="--s-light:#6A737D;--s-dark:#6A737D">/**</span></span>
<span class="line"><span style="--s-light:#6A737D;--s-dark:#6A737D"> * This method returns the first argument it receives.</span></span>
<span class="line"><span style="--s-light:#6A737D;--s-dark:#6A737D"> *</span></span>
<span class="line"><span style="--s-light:#6A737D;--s-dark:#6A737D"> * </span><span style="--s-light:#D73A49;--s-dark:#F97583">@static</span></span>
<span class="line"><span style="--s-light:#6A737D;--s-dark:#6A737D"> * </span><span style="--s-light:#D73A49;--s-dark:#F97583">@since</span><span style="--s-light:#6A737D;--s-dark:#6A737D"> 0.1.0</span></span>
<span class="line"><span style="--s-light:#6A737D;--s-dark:#6A737D"> * </span><span style="--s-light:#D73A49;--s-dark:#F97583">@memberOf</span><span style="--s-light:#6A737D;--s-dark:#6A737D"> _</span></span>
<span class="line"><span style="--s-light:#6A737D;--s-dark:#6A737D"> * </span><span style="--s-light:#D73A49;--s-dark:#F97583">@category</span><span style="--s-light:#6A737D;--s-dark:#6A737D"> Util</span></span>
<span class="line"><span style="--s-light:#6A737D;--s-dark:#6A737D"> * </span><span style="--s-light:#D73A49;--s-dark:#F97583">@param</span><span style="--s-light:#6F42C1;--s-dark:#B392F0"> {*}</span><span style="--s-light:#24292E;--s-dark:#E1E4E8"> value</span><span style="--s-light:#6A737D;--s-dark:#6A737D"> Any value.</span></span>
<span class="line"><span style="--s-light:#6A737D;--s-dark:#6A737D"> * </span><span style="--s-light:#D73A49;--s-dark:#F97583">@returns</span><span style="--s-light:#6F42C1;--s-dark:#B392F0"> {*}</span><span style="--s-light:#6A737D;--s-dark:#6A737D"> Returns `value`.</span></span>
<span class="line"><span style="--s-light:#6A737D;--s-dark:#6A737D"> * </span><span style="--s-light:#D73A49;--s-dark:#F97583">@example</span></span>
<span class="line"><span style="--s-light:#6A737D;--s-dark:#6A737D"> *</span></span>
<span class="line"><span style="--s-light:#6A737D;--s-dark:#6A737D"> * var object = { 'a': 1 };</span></span>
<span class="line"><span style="--s-light:#6A737D;--s-dark:#6A737D"> *</span></span>
<span class="line"><span style="--s-light:#6A737D;--s-dark:#6A737D"> * console.log(_.identity(object) === object);</span></span>
<span class="line"><span style="--s-light:#6A737D;--s-dark:#6A737D"> * // =&gt; true</span></span>
<span class="line"><span style="--s-light:#6A737D;--s-dark:#6A737D"> */</span></span>
<span class="line"><span style="--s-light:#D73A49;--s-dark:#F97583">function</span><span style="--s-light:#6F42C1;--s-dark:#B392F0"> identity</span><span style="--s-light:#24292E;--s-dark:#E1E4E8">(</span><span style="--s-light:#E36209;--s-dark:#FFAB70">value</span><span style="--s-light:#24292E;--s-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--s-light:#D73A49;--s-dark:#F97583">  return</span><span style="--s-light:#24292E;--s-dark:#E1E4E8"> value</span></span>
<span class="line"><span style="--s-light:#24292E;--s-dark:#E1E4E8">}</span></span></code></pre><p>原因找到了，是怎么引起的呢？</p><p>网上搜到了这篇文章<a href="https://zhuanlan.zhihu.com/p/349260482" target="_blank" rel="noopener">为什么你应该立即停止使用 lodash-webpack-plugin</a></p><p>原来是<a href="https://github.com/lodash/lodash-webpack-plugin" target="_blank" rel="noopener">lodash-webpack-plugin</a>插件搞出来的。</p><p>通过用 noop、identity 或更简单的替代方案替换模块的功能集来创建更小的 Lodash 构建。该插件通过进一步缩小精选的构建来补充 babel-plugin-lodash！ 在未启用适当功能集的情况下使用此插件可能会导致 lodash 函数以意想不到的方式运行。方法可能看起来有效，但它们可能返回不正确的结果，其中就包括克隆函数。</p><p>最后看了下生产构建，生产没有引用到这个插件，所以没发现影响。开发环境去掉这个插件。</p></div><!--]--></article><div class="prose m-auto mt-8 mb-8 slide-enter animate-delay-500 print:hidden"><!----><br><span font-mono="" op50="">&gt; </span><a href="/posts" class="router-link-active font-mono op50 hover:op75"></a></div><!--]--><div class="mt-10 mb-6 prose m-auto flex slide-enter animate-delay-1200!"><span class="text-sm op50">@2024-2025 湘ICP备2024048835号</span><div class="flex-auto"></div></div></main><!----><!--]--></div></body></html>